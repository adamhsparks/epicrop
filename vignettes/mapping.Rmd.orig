---
title: Mapping Simulations
author: Adam H. Sparks
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Mapping Simulations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{ggplot2}
  %\VignetteDepends{ggspatial}
  %\VignetteDepends{lubridate}
  %\VignetteDepends{dplyr}
  %\VignetteDepends{purrr}
  %\VignetteDepends{furrr}
  %\VignetteDepends{pander}
---

<!-- STOP! Do not edit this file. This file is generated from multiples.Rmd.orig -->

```{r setup, include = FALSE}
suggested_packages <-
  c(
    "ggplot2",
    "ggspatial",
    "lubridate",
    "dplyr",
    "purrr",
    "furrr",
    "microbenchmark",
    "pander"
  )

knitr::opts_chunk$set(eval = all(
  vapply(
    suggested_packages,
    requireNamespace,
    quietly = TRUE,
    FUN.VALUE = FALSE
  )
))

opts_knit$set(progress=FALSE)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 7
)
```

You may wish to compare the effects of different establishment dates, different seasons or different locations on disease levels.
This vignette details how you can automate several runs of _epicrop_ in R and visualise them on maps.
If you have not familiarised yourself with the workflow for multiple runs in the "Multiple Simulations" vignette, please read that first if you are unfamiliar with using `purrr`.

## Map of AUDPC at multiple locations

In this example we will fetch data for the Mekong River Delta and Red River Delta in Vietnam; Prachin Buri, Thailand; Chennai, India and Nueva Ecija, in the Philippines for the wet season (second half of the year) in 2000.
The map will show a point, with the size relative to the AUDPC value for that location using the latitude and longitude values that were supplied to fetch the weather data.

The [_ggspatial_](https://paleolimbot.github.io/ggspatial/) package is used to provide a base layer of countries using [Open Street Map](https://www.openstreetmap.org/) map baselayer data and labelling capabilities.

```{r map-AUDPC, fig.cap="Rice bacterial blight area under the disease progress curve (AUDPC) values for an establishment date of June 30, 2000 at five locations, Mekong River Delta and Red River Delta in Vietnam; Prachin Buri, Thailand; Chennai, India and Nueva Ecija, in the Philippines.", message = FALSE}
library("epicrop")
library("purrr")

locations <- list(
  "Mekong River" = c(105.5943, 10.0634),
  "Red River" = c(105.9700, 20.9034),
  "Prachin Buri" = c(101.6601, 14.0421),
  "Chennai" = c(80.2707, 13.0827),
  "Neuva Ecija" = c(121.1113, 15.5784)
)

locations_wth <-
  map(
    .x = locations,
    .f = get_wth,
    dates = "2000-06-30",
    duration = 120
  )

# `map()` from purrr is not to be confused with the actual map we are creating
map(
  .x = locations_wth,
  .f = ~ predict_bacterial_blight(emergence = .x$YYYYMMDD[1],
                                  wth = .x)
) %>%
  bind_rows(.id = "location") %>%
  group_by(location) %>%
  distinct(AUDPC, location, lon, lat) %>%
  ggplot(aes(x = lon, y = lat)) +
  annotation_map_tile(type = "cartolight",
                      zoomin = 0) +
  geom_spatial_point(aes(size = AUDPC)) +
  geom_spatial_label_repel(aes(label = paste(location,
                                             round(AUDPC, 0),
                                             sep = ", ")),
                           box.padding = 1,
                           size = 3) +
  theme(legend.position = "none") +
  labs(caption = "Â© OpenStreetMap contributors",
       x = "Longitude",
       y = "Latitude") +
  ylim(c(0, 25)) +
  xlim(c(75, 127)) +
  coord_sf(crs = 4326)
```
